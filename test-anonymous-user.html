<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœªç™»å½•ç”¨æˆ·è®¿å®¢èº«ä»½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
            line-height: 1.6;
        }
        
        h1 {
            color: #ffff00;
            text-align: center;
        }
        
        .test-section {
            background: #2a2a2a;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        
        .error {
            border-left-color: #ff4444;
            color: #ff9999;
        }
        
        .warning {
            border-left-color: #ffaa00;
            color: #ffdd99;
        }
        
        .success {
            border-left-color: #00ff00;
            color: #99ff99;
        }
        
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .danger {
            background: #f44336;
        }
        
        .danger:hover {
            background: #da190b;
        }
        
        pre {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .status.ok {
            background: #4CAF50;
            color: white;
        }
        
        .status.fail {
            background: #f44336;
            color: white;
        }
        
        .status.warn {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æœªç™»å½•ç”¨æˆ·è®¿å®¢èº«ä»½è¯†åˆ«æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ§åˆ¶</h2>
        <button onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button onclick="clearAllData()" class="danger">ğŸ§¹ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button onclick="showCurrentState()">ğŸ“Š æ˜¾ç¤ºå½“å‰çŠ¶æ€</button>
        <button onclick="simulateRecording()">ğŸ™ï¸ æ¨¡æ‹Ÿå½•éŸ³</button>
        <button onclick="testBackendSync()">ğŸŒ æµ‹è¯•åç«¯åŒæ­¥</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
        <div id="currentStatus">ç‚¹å‡»"æ˜¾ç¤ºå½“å‰çŠ¶æ€"æŸ¥çœ‹</div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <pre id="testLog">å‡†å¤‡å¼€å§‹æµ‹è¯•...</pre>
    </div>
    
    <div class="test-section">
        <h2>ğŸ” é—®é¢˜è¯Šæ–­</h2>
        <div id="diagnosis">ç­‰å¾…è¯Šæ–­ç»“æœ...</div>
    </div>

    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${prefix} ${message}`);
        }
        
        // ç®€åŒ–çš„è®¿å®¢èº«ä»½æœåŠ¡
        class GuestIdentityService {
            constructor() {
                this.VISITOR_ID_KEY = 'visitor_id';
                this.GUEST_USAGE_KEY = 'guestUsedMinutes';
                this.GUEST_IDENTITY_KEY = 'guest_identity';
                this.GUEST_SESSIONS_KEY = 'guest_sessions';
                this.GUEST_LIMIT_MINUTES = 5;
            }
            
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            generateSimpleFingerprint() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 0
                ];
                
                let hash = 0;
                const str = components.join('|');
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }
            
            async getGuestIdentity() {
                let visitorId = localStorage.getItem(this.VISITOR_ID_KEY);
                if (!visitorId) {
                    visitorId = this.generateUUID();
                    localStorage.setItem(this.VISITOR_ID_KEY, visitorId);
                    log(`ç”Ÿæˆæ–°çš„è®¿å®¢ID: ${visitorId.substring(0, 8)}...`);
                }
                
                const fingerprint = this.generateSimpleFingerprint();
                const totalMinutesUsed = Number(localStorage.getItem(this.GUEST_USAGE_KEY) || '0');
                const sessions = JSON.parse(localStorage.getItem(this.GUEST_SESSIONS_KEY) || '[]');
                
                const identity = {
                    visitorId,
                    fingerprint,
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        screen: `${screen.width}x${screen.height}`
                    },
                    usageInfo: {
                        totalMinutesUsed,
                        sessionsCount: sessions.length,
                        lastUsedAt: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    }
                };
                
                localStorage.setItem(this.GUEST_IDENTITY_KEY, JSON.stringify(identity));
                return identity;
            }
            
            async validateGuestAccess() {
                const identity = await this.getGuestIdentity();
                const remainingMinutes = Math.max(0, this.GUEST_LIMIT_MINUTES - identity.usageInfo.totalMinutesUsed);
                const isAllowed = remainingMinutes > 0;
                
                let riskLevel = 'low';
                const warnings = [];
                
                if (identity.usageInfo.totalMinutesUsed >= this.GUEST_LIMIT_MINUTES) {
                    riskLevel = 'high';
                    warnings.push('å·²è¾¾åˆ°è®¿å®¢ç”¨æˆ·ä½¿ç”¨ä¸Šé™');
                } else if (identity.usageInfo.totalMinutesUsed >= this.GUEST_LIMIT_MINUTES * 0.8) {
                    riskLevel = 'medium';
                    warnings.push('æ¥è¿‘è®¿å®¢ç”¨æˆ·ä½¿ç”¨ä¸Šé™');
                }
                
                if (identity.usageInfo.sessionsCount > 20) {
                    riskLevel = 'high';
                    warnings.push('è®¿é—®é¢‘ç‡å¼‚å¸¸');
                }
                
                return {
                    isAllowed,
                    remainingMinutes,
                    identity,
                    riskLevel,
                    warnings
                };
            }
            
            recordSession() {
                const sessions = JSON.parse(localStorage.getItem(this.GUEST_SESSIONS_KEY) || '[]');
                sessions.push({
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                
                if (sessions.length > 50) {
                    sessions.splice(0, sessions.length - 50);
                }
                
                localStorage.setItem(this.GUEST_SESSIONS_KEY, JSON.stringify(sessions));
                log(`è®°å½•æ–°ä¼šè¯ï¼Œæ€»ä¼šè¯æ•°: ${sessions.length}`);
            }
            
            updateUsage(minutesUsed) {
                const currentUsage = Number(localStorage.getItem(this.GUEST_USAGE_KEY) || '0');
                const newUsage = currentUsage + minutesUsed;
                localStorage.setItem(this.GUEST_USAGE_KEY, newUsage.toString());
                log(`ä½¿ç”¨é‡æ›´æ–°: +${minutesUsed}åˆ†é’Ÿ, æ€»è®¡: ${newUsage}åˆ†é’Ÿ`);
                
                // æ›´æ–°èº«ä»½ä¿¡æ¯ä¸­çš„ä½¿ç”¨é‡
                const identity = localStorage.getItem(this.GUEST_IDENTITY_KEY);
                if (identity) {
                    const identityData = JSON.parse(identity);
                    identityData.usageInfo.totalMinutesUsed = newUsage;
                    identityData.usageInfo.lastUsedAt = new Date().toISOString();
                    localStorage.setItem(this.GUEST_IDENTITY_KEY, JSON.stringify(identityData));
                }
            }
            
            async reportGuestIdentity(identity) {
                try {
                    const response = await fetch('http://localhost:3001/api/guest/identity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            visitorId: identity.visitorId,
                            fingerprint: identity.fingerprint,
                            deviceInfo: identity.deviceInfo,
                            usageInfo: identity.usageInfo
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        log(`åç«¯ä¸ŠæŠ¥æˆåŠŸ: ${result.message}`, 'success');
                        return result;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    log(`åç«¯ä¸ŠæŠ¥å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            clearGuestData() {
                localStorage.removeItem(this.VISITOR_ID_KEY);
                localStorage.removeItem(this.GUEST_USAGE_KEY);
                localStorage.removeItem(this.GUEST_IDENTITY_KEY);
                localStorage.removeItem(this.GUEST_SESSIONS_KEY);
                log('æ‰€æœ‰è®¿å®¢æ•°æ®å·²æ¸…é™¤', 'warn');
            }
        }
        
        // åˆ›å»ºæœåŠ¡å®ä¾‹
        const guestService = new GuestIdentityService();
        
        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        function showCurrentState() {
            const statusElement = document.getElementById('currentStatus');
            
            const authToken = localStorage.getItem('authToken');
            const guestMode = localStorage.getItem('guestMode');
            const userData = localStorage.getItem('userData');
            const guestUsedMinutes = localStorage.getItem('guestUsedMinutes');
            const visitorId = localStorage.getItem('visitor_id');
            const guestIdentity = localStorage.getItem('guest_identity');
            const guestSessions = localStorage.getItem('guest_sessions');
            
            statusElement.innerHTML = `
                <strong>ğŸ” è®¤è¯çŠ¶æ€:</strong><br>
                â€¢ authToken: ${authToken ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>
                â€¢ guestMode: ${guestMode || 'âŒ æœªè®¾ç½®'}<br>
                â€¢ userData: ${userData ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br><br>
                
                <strong>ğŸ‘¤ è®¿å®¢èº«ä»½:</strong><br>
                â€¢ visitor_id: ${visitorId ? `âœ… ${visitorId.substring(0, 8)}...` : 'âŒ ä¸å­˜åœ¨'}<br>
                â€¢ guest_identity: ${guestIdentity ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br><br>
                
                <strong>ğŸ“Š ä½¿ç”¨ç»Ÿè®¡:</strong><br>
                â€¢ guestUsedMinutes: ${guestUsedMinutes || '0'} åˆ†é’Ÿ<br>
                â€¢ å‰©ä½™æ—¶é•¿: ${Math.max(0, 5 - Number(guestUsedMinutes || '0')).toFixed(1)} åˆ†é’Ÿ<br>
                â€¢ guest_sessions: ${guestSessions ? JSON.parse(guestSessions).length : 0} æ¬¡<br><br>
                
                <strong>ğŸš¨ é—®é¢˜è¯Šæ–­:</strong><br>
                â€¢ æ˜¯å¦ä¸ºæœªç™»å½•ç”¨æˆ·: ${!authToken && !guestMode ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                â€¢ æ˜¯å¦æœ‰è®¿å®¢èº«ä»½: ${visitorId ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                â€¢ ä½¿ç”¨é‡æ˜¯å¦æ­£ç¡®: ${guestUsedMinutes !== null ? 'âœ… æ˜¯' : 'âŒ å¦'}
            `;
            
            log('å½“å‰çŠ¶æ€å·²æ›´æ–°');
        }
        
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                guestService.clearGuestData();
                showCurrentState();
                log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warn');
            }
        }
        
        // æ¨¡æ‹Ÿå½•éŸ³
        async function simulateRecording() {
            log('ğŸ™ï¸ å¼€å§‹æ¨¡æ‹Ÿå½•éŸ³è¿‡ç¨‹...');
            
            // æ­¥éª¤1: æ£€æŸ¥å½“å‰çŠ¶æ€
            const validationBefore = await guestService.validateGuestAccess();
            log(`å½•éŸ³å‰çŠ¶æ€: å‰©ä½™${validationBefore.remainingMinutes.toFixed(1)}åˆ†é’Ÿ`);
            
            // æ­¥éª¤2: æ¨¡æ‹Ÿå½•éŸ³1åˆ†é’Ÿ
            const recordingDuration = 1.0;
            guestService.updateUsage(recordingDuration);
            
            // æ­¥éª¤3: æ£€æŸ¥å½•éŸ³åçŠ¶æ€
            const validationAfter = await guestService.validateGuestAccess();
            log(`å½•éŸ³åçŠ¶æ€: å‰©ä½™${validationAfter.remainingMinutes.toFixed(1)}åˆ†é’Ÿ`, 
                validationAfter.isAllowed ? 'success' : 'warn');
            
            // æ­¥éª¤4: æ›´æ–°æ˜¾ç¤º
            showCurrentState();
        }
        
        // æµ‹è¯•åç«¯åŒæ­¥
        async function testBackendSync() {
            try {
                log('ğŸŒ å¼€å§‹æµ‹è¯•åç«¯åŒæ­¥...');
                const identity = await guestService.getGuestIdentity();
                await guestService.reportGuestIdentity(identity);
                log('åç«¯åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log(`åç«¯åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...', 'success');
            
            try {
                // æ­¥éª¤1: æ¸…é™¤æ•°æ®ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡è®¿é—®
                log('æ­¥éª¤1: æ¸…é™¤æ•°æ®ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡è®¿é—®');
                localStorage.clear();
                
                // æ­¥éª¤2: æ£€æŸ¥åˆå§‹çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿæœªç™»å½•ç”¨æˆ·ï¼‰
                log('æ­¥éª¤2: æ£€æŸ¥åˆå§‹çŠ¶æ€');
                const hasAuth = !!localStorage.getItem('authToken');
                const hasGuestMode = !!localStorage.getItem('guestMode');
                const hasUserData = !!localStorage.getItem('userData');
                
                log(`åˆå§‹çŠ¶æ€: authToken=${hasAuth}, guestMode=${hasGuestMode}, userData=${hasUserData}`);
                
                // æ­¥éª¤3: åˆå§‹åŒ–è®¿å®¢èº«ä»½ï¼ˆæ¨¡æ‹Ÿè®¿é—®é¡µé¢ï¼‰
                log('æ­¥éª¤3: åˆå§‹åŒ–è®¿å®¢èº«ä»½');
                guestService.recordSession();
                const identity = await guestService.getGuestIdentity();
                log(`è®¿å®¢èº«ä»½åˆ›å»º: ID=${identity.visitorId.substring(0, 8)}..., æŒ‡çº¹=${identity.fingerprint.substring(0, 8)}...`);
                
                // æ­¥éª¤4: éªŒè¯è®¿é—®æƒé™
                log('æ­¥éª¤4: éªŒè¯è®¿é—®æƒé™');
                const validation1 = await guestService.validateGuestAccess();
                log(`è®¿é—®æƒé™: å…è®¸=${validation1.isAllowed}, å‰©ä½™=${validation1.remainingMinutes.toFixed(1)}åˆ†é’Ÿ`);
                
                // æ­¥éª¤5: æ¨¡æ‹Ÿä½¿ç”¨ï¼ˆå½•éŸ³è½¬æ–‡å­—ï¼‰
                log('æ­¥éª¤5: æ¨¡æ‹Ÿä½¿ç”¨ï¼ˆå½•éŸ³è½¬æ–‡å­—ï¼‰');
                guestService.updateUsage(2.5);
                const validation2 = await guestService.validateGuestAccess();
                log(`ä½¿ç”¨åçŠ¶æ€: å…è®¸=${validation2.isAllowed}, å‰©ä½™=${validation2.remainingMinutes.toFixed(1)}åˆ†é’Ÿ`);
                
                // æ­¥éª¤6: æµ‹è¯•åç«¯åŒæ­¥
                log('æ­¥éª¤6: æµ‹è¯•åç«¯åŒæ­¥');
                try {
                    await guestService.reportGuestIdentity(validation2.identity);
                    log('åç«¯åŒæ­¥æˆåŠŸ', 'success');
                } catch (error) {
                    log(`åç«¯åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æ­¥éª¤7: æ¨¡æ‹Ÿè¶…é™ä½¿ç”¨
                log('æ­¥éª¤7: æ¨¡æ‹Ÿè¶…é™ä½¿ç”¨');
                guestService.updateUsage(3.0); // æ€»è®¡5.5åˆ†é’Ÿ
                const validation3 = await guestService.validateGuestAccess();
                log(`è¶…é™åçŠ¶æ€: å…è®¸=${validation3.isAllowed}, å‰©ä½™=${validation3.remainingMinutes.toFixed(1)}åˆ†é’Ÿ`);
                
                // æ­¥éª¤8: è¯Šæ–­ç»“æœ
                log('æ­¥éª¤8: ç”Ÿæˆè¯Šæ–­ç»“æœ');
                const diagnosis = document.getElementById('diagnosis');
                diagnosis.innerHTML = `
                    <h3>ğŸ” æµ‹è¯•ç»“æœè¯Šæ–­</h3>
                    <p><span class="status ${identity.visitorId ? 'ok' : 'fail'}">${identity.visitorId ? 'âœ…' : 'âŒ'}</span> è®¿å®¢IDç”Ÿæˆ</p>
                    <p><span class="status ${identity.fingerprint ? 'ok' : 'fail'}">${identity.fingerprint ? 'âœ…' : 'âŒ'}</span> è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ</p>
                    <p><span class="status ${validation2.identity.usageInfo.totalMinutesUsed === 2.5 ? 'ok' : 'fail'}">${validation2.identity.usageInfo.totalMinutesUsed === 2.5 ? 'âœ…' : 'âŒ'}</span> ä½¿ç”¨é‡è®°å½•æ­£ç¡®</p>
                    <p><span class="status ${!validation3.isAllowed ? 'ok' : 'fail'}">${!validation3.isAllowed ? 'âœ…' : 'âŒ'}</span> è¶…é™åæ­£ç¡®é˜»æ­¢</p>
                    <p><span class="status ${validation3.identity.usageInfo.sessionsCount > 0 ? 'ok' : 'fail'}">${validation3.identity.usageInfo.sessionsCount > 0 ? 'âœ…' : 'âŒ'}</span> ä¼šè¯è®°å½•æ­£ç¡®</p>
                    
                    <h4>ğŸ“Š å…³é”®æ•°æ®æ£€æŸ¥:</h4>
                    <p>â€¢ è®¿å®¢ID: ${identity.visitorId}</p>
                    <p>â€¢ è®¾å¤‡æŒ‡çº¹: ${identity.fingerprint}</p>
                    <p>â€¢ æ€»ä½¿ç”¨æ—¶é•¿: ${validation3.identity.usageInfo.totalMinutesUsed} åˆ†é’Ÿ</p>
                    <p>â€¢ å‰©ä½™æ—¶é•¿: ${validation3.remainingMinutes.toFixed(1)} åˆ†é’Ÿ</p>
                    <p>â€¢ ä¼šè¯æ¬¡æ•°: ${validation3.identity.usageInfo.sessionsCount}</p>
                    <p>â€¢ é£é™©ç­‰çº§: ${validation3.riskLevel}</p>
                `;
                
                showCurrentState();
                log('ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºçŠ¶æ€
        window.onload = function() {
            log('ğŸ§ª æµ‹è¯•é¡µé¢å·²åŠ è½½');
            showCurrentState();
        };
    </script>
</body>
</html>